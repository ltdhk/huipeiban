# CareLink AI Agent è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ–‡æ¡£ç‰ˆæœ¬ | v1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025-11-12 |
| AIæ¡†æ¶ | LangChain |
| LLMæä¾›å•† | OpenRouter |

---

## ä¸€ã€AI Agent æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

CareLink AI Agent æ˜¯ä¸€ä¸ªåŸºäº LangChain æ„å»ºçš„æ™ºèƒ½å¯¹è¯åŠ©æ‰‹ï¼Œæ—¨åœ¨é€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’å¸®åŠ©ç”¨æˆ·ï¼š

1. **ç†è§£éœ€æ±‚**ï¼šé€šè¿‡å¤šè½®å¯¹è¯æå–ç”¨æˆ·çš„é™ªè¯Šéœ€æ±‚ä¿¡æ¯
2. **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®æå–çš„ä¿¡æ¯æ™ºèƒ½åŒ¹é…å’Œæ¨èé™ªè¯Šå¸ˆ/æœºæ„
3. **å¼•å¯¼é¢„çº¦**ï¼šå¼•å¯¼ç”¨æˆ·å®Œæˆé¢„çº¦æµç¨‹
4. **ç­”ç–‘è§£æƒ‘**ï¼šå›ç­”ç”¨æˆ·å…³äºå¹³å°å’ŒæœåŠ¡çš„é—®é¢˜

### 1.2 æ ¸å¿ƒèƒ½åŠ›

- **æ„å›¾è¯†åˆ« (Intent Recognition)**ï¼šè¯†åˆ«ç”¨æˆ·çš„å¯¹è¯æ„å›¾
- **å®ä½“æŠ½å– (Entity Extraction)**ï¼šä»å¯¹è¯ä¸­æå–å…³é”®ä¿¡æ¯
- **æ§½ä½å¡«å…… (Slot Filling)**ï¼šæ”¶é›†é¢„çº¦æ‰€éœ€çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯
- **ä¸Šä¸‹æ–‡ç®¡ç† (Context Management)**ï¼šç»´æŠ¤å¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡
- **æ™ºèƒ½æ¨è (Recommendation)**ï¼šåŸºäºæå–ä¿¡æ¯æ¨èæœåŠ¡
- **é—®ç­”èƒ½åŠ› (QA)**ï¼šå›ç­”å¹³å°ç›¸å…³é—®é¢˜

### 1.3 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šLangChain (Python)
- **LLM**ï¼šOpenRouter (æ”¯æŒå¤šç§æ¨¡å‹åˆ‡æ¢)
  - ä¸»åŠ›æ¨¡å‹ï¼šGPT-4 / Claude 3.5
  - å¤‡ç”¨æ¨¡å‹ï¼šGPT-3.5-turbo (æˆæœ¬ä¼˜åŒ–)
- **å‘é‡æ•°æ®åº“**ï¼ˆå¯é€‰ï¼‰ï¼šPinecone / Qdrant (ç”¨äºçŸ¥è¯†åº“æ£€ç´¢)
- **å†…å­˜ç®¡ç†**ï¼šLangChain ConversationBufferMemory
- **å·¥å…·é›†æˆ**ï¼šLangChain Tools (è°ƒç”¨æ•°æ®åº“æŸ¥è¯¢ã€æ¨èå¼•æ“ç­‰)

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è¾“å…¥                               â”‚
â”‚              "æˆ‘éœ€è¦æ˜å¤©ä¸Šåˆå»åå’ŒåŒ»é™¢"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LangChain Agent                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ„å›¾è¯†åˆ«    â”‚  â”‚ å®ä½“æŠ½å–    â”‚  â”‚ æ§½ä½å¡«å……    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                â”‚                â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                               â”‚
â”‚                          â–¼                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚  Prompt Template      â”‚                   â”‚
â”‚              â”‚  (æç¤ºè¯å·¥ç¨‹)         â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â”‚                                 â”‚
â”‚                        â–¼                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚  OpenRouter LLM      â”‚                   â”‚
â”‚              â”‚  (GPT-4 / Claude)    â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â”‚                                 â”‚
â”‚                        â–¼                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚  Response Parser     â”‚                   â”‚
â”‚              â”‚  (è§£æ LLM å“åº”)      â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tools (å·¥å…·é›†)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ•°æ®åº“æŸ¥è¯¢  â”‚  â”‚ æ¨èå¼•æ“    â”‚  â”‚ çŸ¥è¯†åº“æ£€ç´¢  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AI å“åº”è¾“å‡º                             â”‚
â”‚  - æ–‡æœ¬å›å¤                                               â”‚
â”‚  - æ¨èç»“æœï¼ˆé™ªè¯Šå¸ˆ/æœºæ„å¡ç‰‡ï¼‰                             â”‚
â”‚  - ä¸‹ä¸€æ­¥å¼•å¯¼                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 Agent é“¾è·¯

```python
from langchain.agents import initialize_agent, Tool
from langchain.chat_models import ChatOpenAI
from langchain.memory import ConversationBufferMemory

# åˆå§‹åŒ– LLMï¼ˆé€šè¿‡ OpenRouterï¼‰
llm = ChatOpenAI(
    openai_api_base="https://openrouter.ai/api/v1",
    openai_api_key=OPENROUTER_API_KEY,
    model_name="anthropic/claude-3.5-sonnet",
    temperature=0.7
)

# å®šä¹‰å·¥å…·
tools = [
    Tool(
        name="SearchCompanions",
        func=search_companions,
        description="æ ¹æ®æ—¶é—´ã€åœ°ç‚¹ã€æœåŠ¡éœ€æ±‚æœç´¢å¯ç”¨çš„é™ªè¯Šå¸ˆ"
    ),
    Tool(
        name="SearchInstitutions",
        func=search_institutions,
        description="æ ¹æ®éœ€æ±‚æœç´¢å¯ç”¨çš„é™ªè¯Šæœºæ„"
    ),
    Tool(
        name="QueryKnowledgeBase",
        func=query_kb,
        description="ä»çŸ¥è¯†åº“æŸ¥è¯¢å¹³å°ç›¸å…³é—®é¢˜ç­”æ¡ˆ"
    )
]

# åˆå§‹åŒ–è®°å¿†
memory = ConversationBufferMemory(
    memory_key="chat_history",
    return_messages=True
)

# åˆå§‹åŒ– Agent
agent = initialize_agent(
    tools=tools,
    llm=llm,
    agent="conversational-react-description",
    memory=memory,
    verbose=True
)
```

---

## ä¸‰ã€å¯¹è¯æµç¨‹è®¾è®¡

### 3.1 æ„å›¾åˆ†ç±»

Agent éœ€è¦è¯†åˆ«ä»¥ä¸‹å‡ ç§æ„å›¾ï¼š

| æ„å›¾ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `book_appointment` | é¢„çº¦é™ªè¯ŠæœåŠ¡ | "æˆ‘æƒ³é¢„çº¦æ˜å¤©çš„é™ªè¯Š" |
| `query_order` | æŸ¥è¯¢è®¢å• | "æˆ‘çš„è®¢å•åœ¨å“ªé‡Œ" |
| `modify_appointment` | ä¿®æ”¹é¢„çº¦ | "æˆ‘æƒ³æ”¹ä¸€ä¸‹æ—¶é—´" |
| `cancel_appointment` | å–æ¶ˆé¢„çº¦ | "å¸®æˆ‘å–æ¶ˆè®¢å•" |
| `ask_question` | å’¨è¯¢é—®é¢˜ | "é™ªè¯Šå¸ˆæ”¶è´¹æ ‡å‡†æ˜¯ä»€ä¹ˆ" |
| `complain` | æŠ•è¯‰åé¦ˆ | "æˆ‘è¦æŠ•è¯‰é™ªè¯Šå¸ˆ" |
| `chit_chat` | é—²èŠ | "ä½ å¥½" |

### 3.2 æ§½ä½å®šä¹‰

é¢„çº¦é™ªè¯ŠæœåŠ¡éœ€è¦æ”¶é›†çš„æ§½ä½ (Slots)ï¼š

| æ§½ä½å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|------|------|--------|
| `appointment_time` | datetime | æ˜¯ | é¢„çº¦æ—¶é—´ | "2025-11-13 09:00" |
| `hospital_name` | string | æ˜¯ | åŒ»é™¢åç§° | "åŒ—äº¬åå’ŒåŒ»é™¢" |
| `hospital_address` | string | å¦ | åŒ»é™¢åœ°å€ | "åŒ—äº¬å¸‚ä¸œåŸåŒº..." |
| `department` | string | å¦ | å°±è¯Šç§‘å®¤ | "éª¨ç§‘" |
| `service_type` | enum | æ˜¯ | æœåŠ¡ç±»å‹ | "åŸºç¡€é™ªè¯Š/ä¸“å®¶é™ªè¯Š/å…¨ç¨‹é™ªæŠ¤" |
| `service_spec` | enum | æ˜¯ | æœåŠ¡è§„æ ¼ | "2å°æ—¶/4å°æ—¶/å…¨å¤©" |
| `need_pickup` | boolean | æ˜¯ | æ˜¯å¦éœ€è¦æ¥é€ | true/false |
| `pickup_type` | enum | å¦ | æ¥é€ç±»å‹ | "both/pickup_only/dropoff_only" |
| `pickup_address` | string | å¦ | æ¥é€åœ°å€ | "æœé˜³åŒºå»ºå›½è·¯1å·" |
| `special_needs` | string | å¦ | ç‰¹æ®Šéœ€æ±‚ | "éœ€è¦è½®æ¤…" |
| `patient_info` | object | æ˜¯ | å°±è¯Šäººä¿¡æ¯ | {name, age, ...} |

### 3.3 å¯¹è¯çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   START     â”‚  åˆå§‹çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UNDERSTANDING_INTENT â”‚  ç†è§£ç”¨æˆ·æ„å›¾
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ book_appointment â”€â”€â”€â”
       â”œâ”€â”€â”€ ask_question â”€â”€â”€â”€â”€â”€â”€â”¤
       â”œâ”€â”€â”€ query_order â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â””â”€â”€â”€ other_intents â”€â”€â”€â”€â”€â”€â”¤
                                 â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COLLECTING_SLOTS    â”‚  æ”¶é›†å¿…è¦ä¿¡æ¯ï¼ˆé’ˆå¯¹é¢„çº¦æ„å›¾ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ (å¤šè½®å¯¹è¯ï¼Œé€æ­¥å¡«å……æ§½ä½)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SLOTS_COMPLETE      â”‚  ä¿¡æ¯æ”¶é›†å®Œæ•´
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GENERATING_RECS     â”‚  ç”Ÿæˆæ¨èç»“æœ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SHOWING_RECS        â”‚  å±•ç¤ºé™ªè¯Šå¸ˆ/æœºæ„æ¨è
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ (ç”¨æˆ·é€‰æ‹©æ¨èç»“æœ)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONFIRMING_ORDER    â”‚  ç¡®è®¤è®¢å•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   COMPLETED         â”‚  å¯¹è¯å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 å¯¹è¯ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šå®Œæ•´é¢„çº¦æµç¨‹

```
ç”¨æˆ·: "æˆ‘éœ€è¦é¢„çº¦æ˜å¤©ä¸Šåˆå»åå’ŒåŒ»é™¢çš„é™ªè¯ŠæœåŠ¡"

AI: "å¥½çš„ï¼Œæˆ‘å·²ä¸ºæ‚¨è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
     â€¢ æ—¶é—´ï¼šæ˜å¤©ä¸Šåˆ
     â€¢ åŒ»é™¢ï¼šåŒ—äº¬åå’ŒåŒ»é™¢

     è¯·é—®æ‚¨éœ€è¦å“ªç§ç±»å‹çš„é™ªè¯ŠæœåŠ¡å‘¢ï¼Ÿ
     1. åŸºç¡€é™ªè¯Šï¼ˆæŒ‚å·ã€å€™è¯Šã€å–è¯ï¼‰
     2. ä¸“å®¶é™ªè¯Šï¼ˆå…¨ç¨‹é™ªåŒã€ååŠ©æ²Ÿé€šï¼‰
     3. å…¨ç¨‹é™ªæŠ¤ï¼ˆåŒ…å«æœ¯å‰æœ¯åç…§é¡¾ï¼‰"

ç”¨æˆ·: "åŸºç¡€é™ªè¯Šå°±å¯ä»¥"

AI: "æ˜ç™½äº†ã€‚è¯·é—®æ‚¨é¢„è®¡éœ€è¦å¤šé•¿æ—¶é—´çš„æœåŠ¡ï¼Ÿ
     1. 2å°æ—¶ï¼ˆé€‚åˆç®€å•å¤è¯Šï¼‰ - Â¥129
     2. 4å°æ—¶ï¼ˆé€‚åˆæ£€æŸ¥å–è¯ï¼‰ - Â¥199
     3. å…¨å¤©ï¼ˆé€‚åˆå¤æ‚æ£€æŸ¥ï¼‰ - Â¥399"

ç”¨æˆ·: "4å°æ—¶"

AI: "å¥½çš„ã€‚è¯·é—®æ‚¨æ˜¯å¦éœ€è¦æ¥é€æœåŠ¡ï¼Ÿ"

ç”¨æˆ·: "éœ€è¦ï¼Œæ¥å›æ¥é€"

AI: "å¥½çš„ï¼Œæˆ‘å·²ä¸ºæ‚¨è®°å½•éœ€è¦å¾€è¿”æ¥é€ã€‚è¯·é—®æ¥é€åœ°å€æ˜¯ï¼Ÿ"

ç”¨æˆ·: "æœé˜³åŒºå»ºå›½è·¯1å·"

AI: "æ”¶åˆ°ï¼è®©æˆ‘ä¸ºæ‚¨æŸ¥æ‰¾åˆé€‚çš„é™ªè¯ŠæœåŠ¡...

     âœ… å·²ä¸ºæ‚¨æ‰¾åˆ° 3 ä½ç¬¦åˆè¦æ±‚çš„é™ªè¯Šå¸ˆå’Œ 2 å®¶é™ªè¯Šæœºæ„

     ã€æ¨èé™ªè¯Šå¸ˆã€‘
     â­ ç‹æŠ¤å£« - 4.9åˆ† (120è¯„ä»·)
        â€¢ 5å¹´ç»éªŒï¼Œæ“…é•¿è€å¹´é™ªæŠ¤
        â€¢ æœ‰è½¦ï¼Œç†Ÿæ‚‰åå’ŒåŒ»é™¢
        â€¢ ä»·æ ¼ï¼šÂ¥199 (æœåŠ¡è´¹) + Â¥100 (æ¥é€è´¹)
        [ç«‹å³é¢„çº¦]

     â­ æé™ªæŠ¤ - 4.8åˆ† (95è¯„ä»·)
        â€¢ 3å¹´ç»éªŒï¼Œè€å¿ƒç»†è‡´
        â€¢ æœ‰è½¦ï¼ŒæœåŠ¡å‘¨åˆ°
        â€¢ ä»·æ ¼ï¼šÂ¥189 (æœåŠ¡è´¹) + Â¥100 (æ¥é€è´¹)
        [ç«‹å³é¢„çº¦]

     ã€æ¨èé™ªè¯Šæœºæ„ã€‘
     ğŸ¢ åº·æŠ¤é™ªè¯Šä¸­å¿ƒ - 4.8åˆ† (500è¯„ä»·)
        â€¢ ä¸“ä¸šå›¢é˜Ÿï¼Œç»éªŒä¸°å¯Œ
        â€¢ è¦†ç›–å…¨å¸‚ä¸»è¦åŒ»é™¢
        [å’¨è¯¢é¢„çº¦ï¼ˆå…è´¹ï¼‰]

     æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©ï¼Œæˆ–å‘Šè¯‰æˆ‘æ‚¨çš„åå¥½ã€‚"

ç”¨æˆ·: "æˆ‘é€‰ç‹æŠ¤å£«"

AI: "å¥½çš„ï¼Œæ‚¨é€‰æ‹©äº†ç‹æŠ¤å£«ã€‚

     è¯·ç¡®è®¤ä»¥ä¸‹é¢„çº¦ä¿¡æ¯ï¼š
     â€¢ é™ªè¯Šå¸ˆï¼šç‹æŠ¤å£«
     â€¢ æ—¶é—´ï¼š2025-11-13 ä¸Šåˆ9:00
     â€¢ åŒ»é™¢ï¼šåŒ—äº¬åå’ŒåŒ»é™¢
     â€¢ æœåŠ¡ï¼šåŸºç¡€é™ªè¯Š (4å°æ—¶)
     â€¢ æ¥é€ï¼šå¾€è¿”æ¥é€
     â€¢ æ¥é€åœ°å€ï¼šæœé˜³åŒºå»ºå›½è·¯1å·
     â€¢ è´¹ç”¨ï¼šÂ¥299

     ç¡®è®¤åå°†è¿›å…¥æ”¯ä»˜æµç¨‹ã€‚"

ç”¨æˆ·: "ç¡®è®¤"

AI: "å¥½çš„ï¼Œè®¢å•å·²åˆ›å»ºæˆåŠŸï¼
     è®¢å•å·ï¼šCL202511131234567890

     è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å®Œæˆæ”¯ä»˜ã€‚æ”¯ä»˜æˆåŠŸåï¼Œç‹æŠ¤å£«å°†æ”¶åˆ°é€šçŸ¥å¹¶ä¸æ‚¨è”ç³»ç¡®è®¤è¯¦ç»†ä¿¡æ¯ã€‚

     [å»æ”¯ä»˜ Â¥299]"
```

#### ç¤ºä¾‹ 2ï¼šä¿¡æ¯ä¸å®Œæ•´æ—¶çš„è¿½é—®

```
ç”¨æˆ·: "å¸®æˆ‘é¢„çº¦é™ªè¯Š"

AI: "å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨é¢„çº¦é™ªè¯ŠæœåŠ¡ã€‚

     è¯·é—®æ‚¨è®¡åˆ’ä»€ä¹ˆæ—¶å€™å°±è¯Šå‘¢ï¼Ÿ"

ç”¨æˆ·: "æ˜å¤©"

AI: "å¥½çš„ï¼Œæ˜å¤©å‡ ç‚¹å‘¢ï¼Ÿä¸Šåˆã€ä¸‹åˆè¿˜æ˜¯å…·ä½“æ—¶é—´ï¼Ÿ"

ç”¨æˆ·: "ä¸Šåˆ9ç‚¹"

AI: "æ”¶åˆ°ï¼Œæ˜å¤©ä¸Šåˆ9ç‚¹ã€‚è¯·é—®æ˜¯å»å“ªå®¶åŒ»é™¢å‘¢ï¼Ÿ"

ç”¨æˆ·: "åå’Œ"

AI: "æ‚¨è¯´çš„æ˜¯åŒ—äº¬åå’ŒåŒ»é™¢å—ï¼Ÿ"

ç”¨æˆ·: "å¯¹"

AI: "å¥½çš„ï¼ŒåŒ—äº¬åå’ŒåŒ»é™¢ã€‚

     æ¥ä¸‹æ¥ï¼Œè¯·é—®æ‚¨éœ€è¦å“ªç§ç±»å‹çš„é™ªè¯ŠæœåŠ¡å‘¢ï¼Ÿ
     ï¼ˆç»§ç»­æ”¶é›†å…¶ä»–æ§½ä½...ï¼‰"
```

#### ç¤ºä¾‹ 3ï¼šé—®ç­”åœºæ™¯

```
ç”¨æˆ·: "é™ªè¯Šå¸ˆæ”¶è´¹æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ"

AI: "æ‚¨å¥½ï¼é™ªè¯Šå¸ˆçš„æ”¶è´¹æ ‡å‡†ä¸»è¦æ ¹æ®æœåŠ¡æ—¶é•¿å’ŒæœåŠ¡å†…å®¹ï¼š

     ã€åŸºç¡€é™ªè¯Šã€‘
     â€¢ 2å°æ—¶ï¼šÂ¥129 - Â¥159
     â€¢ 4å°æ—¶ï¼šÂ¥199 - Â¥239
     â€¢ å…¨å¤©ï¼ˆ8å°æ—¶ï¼‰ï¼šÂ¥399 - Â¥499

     ã€ä¸“å®¶é™ªè¯Šã€‘
     â€¢ 4å°æ—¶ï¼šÂ¥299 - Â¥399
     â€¢ å…¨å¤©ï¼šÂ¥599 - Â¥799

     ã€é¢å¤–æœåŠ¡ã€‘
     â€¢ å•ç¨‹æ¥é€ï¼šÂ¥50
     â€¢ å¾€è¿”æ¥é€ï¼šÂ¥100
     â€¢ ç‰¹æ®ŠæŠ¤ç†ï¼šå¦è®®

     å…·ä½“ä»·æ ¼ç”±é™ªè¯Šå¸ˆèµ„å†ã€ç»éªŒå’ŒæœåŠ¡å†…å®¹å†³å®šã€‚å¦‚éœ€é¢„çº¦ï¼Œæˆ‘å¯ä»¥æ ¹æ®æ‚¨çš„éœ€æ±‚ä¸ºæ‚¨æ¨èåˆé€‚çš„é™ªè¯Šå¸ˆã€‚"

ç”¨æˆ·: "å¯ä»¥å¸®æˆ‘æ‰¾ä¸ªä¾¿å®œç‚¹çš„å—"

AI: "å½“ç„¶å¯ä»¥ï¼æˆ‘åœ¨ä¸ºæ‚¨æ¨èæ—¶ä¼šä¼˜å…ˆå±•ç¤ºæ€§ä»·æ¯”é«˜çš„é™ªè¯Šå¸ˆã€‚

     è¯·é—®æ‚¨å…·ä½“ä»€ä¹ˆæ—¶å€™éœ€è¦æœåŠ¡å‘¢ï¼Ÿ"
```

---

## å››ã€Prompt å·¥ç¨‹

### 4.1 ç³»ç»Ÿæç¤ºè¯ (System Prompt)

```python
SYSTEM_PROMPT = """
ä½ æ˜¯ CareLink åŒ»ç–—é™ªè¯ŠæœåŠ¡å¹³å°çš„ AI åŠ©æ‰‹ï¼Œåå­—å«"å°æŠ¤"ã€‚ä½ çš„èŒè´£æ˜¯å¸®åŠ©ç”¨æˆ·é¢„çº¦é™ªè¯ŠæœåŠ¡ã€‚

## ä½ çš„èƒ½åŠ›
- ç†è§£ç”¨æˆ·çš„é™ªè¯Šéœ€æ±‚
- æå–å…³é”®ä¿¡æ¯ï¼ˆæ—¶é—´ã€åœ°ç‚¹ã€æœåŠ¡ç±»å‹ç­‰ï¼‰
- æ¨èåˆé€‚çš„é™ªè¯Šå¸ˆæˆ–é™ªè¯Šæœºæ„
- å›ç­”å¹³å°ç›¸å…³é—®é¢˜

## å¯¹è¯é£æ ¼
- å‹å¥½ã€ä¸“ä¸šã€è€å¿ƒ
- ä½¿ç”¨ç®€ä½“ä¸­æ–‡
- å›å¤ç®€æ´æ¸…æ™°ï¼Œé¿å…å†—é•¿
- ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢åŠ äº²å’ŒåŠ›ï¼ˆé€‚åº¦ä½¿ç”¨ï¼‰

## é‡è¦è§„åˆ™
1. **ä¿¡æ¯æ”¶é›†**ï¼šå¦‚æœç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œé€šè¿‡è¿½é—®é€æ­¥æ”¶é›†ï¼Œæ¯æ¬¡åªé—®1-2ä¸ªé—®é¢˜
2. **ç¡®è®¤ä¿¡æ¯**ï¼šåœ¨æ¨èæœåŠ¡å‰ï¼Œç¡®è®¤å·²ç†è§£ç”¨æˆ·çš„æ‰€æœ‰å…³é”®éœ€æ±‚
3. **æ˜ç¡®é€‰é¡¹**ï¼šæä¾›é€‰æ‹©æ—¶ï¼Œç»™å‡ºæ¸…æ™°çš„é€‰é¡¹ï¼ˆå¦‚ 1/2/3 æˆ–æŒ‰é’®ï¼‰
4. **ä»·æ ¼é€æ˜**ï¼šæåŠæœåŠ¡æ—¶è¦è¯´æ˜ä»·æ ¼
5. **ä¸è¦å‡è®¾**ï¼šä¸è¦çŒœæµ‹ç”¨æˆ·çš„éœ€æ±‚ï¼Œä¸ç¡®å®šæ—¶ä¸€å®šè¦é—®æ¸…æ¥š

## å¿…é¡»æ”¶é›†çš„ä¿¡æ¯ï¼ˆé¢„çº¦é™ªè¯Šæ—¶ï¼‰
- âœ… å°±è¯Šæ—¶é—´
- âœ… å°±è¯ŠåŒ»é™¢
- âœ… æœåŠ¡ç±»å‹ï¼ˆåŸºç¡€/ä¸“å®¶/å…¨ç¨‹ï¼‰
- âœ… æœåŠ¡è§„æ ¼ï¼ˆ2å°æ—¶/4å°æ—¶/å…¨å¤©ï¼‰
- âœ… æ˜¯å¦éœ€è¦æ¥é€
- âš ï¸ æ¥é€åœ°å€ï¼ˆå¦‚éœ€è¦æ¥é€ï¼‰

## å½“å‰æ—¥æœŸæ—¶é—´
{current_datetime}

## å¯ç”¨å·¥å…·
ä½ å¯ä»¥è°ƒç”¨ä»¥ä¸‹å·¥å…·æ¥è¾…åŠ©å›ç­”ï¼š
- SearchCompanions: æœç´¢ç¬¦åˆæ¡ä»¶çš„é™ªè¯Šå¸ˆ
- SearchInstitutions: æœç´¢ç¬¦åˆæ¡ä»¶çš„é™ªè¯Šæœºæ„
- QueryKnowledgeBase: æŸ¥è¯¢å¹³å°å¸¸è§é—®é¢˜

ç°åœ¨ï¼Œè¯·å¼€å§‹ä¸ç”¨æˆ·å¯¹è¯ã€‚
"""
```

### 4.2 å¯¹è¯æ¨¡æ¿ (Conversation Template)

```python
CONVERSATION_TEMPLATE = """
ä»¥ä¸‹æ˜¯ä½ ä¸ç”¨æˆ·çš„å¯¹è¯å†å²ï¼š

{chat_history}

ç”¨æˆ·æœ€æ–°æ¶ˆæ¯ï¼š{input}

## å½“å‰å·²æ”¶é›†çš„ä¿¡æ¯
{collected_slots}

## ç¼ºå¤±çš„å¿…å¡«ä¿¡æ¯
{missing_slots}

## ä»»åŠ¡
1. åˆ†æç”¨æˆ·æœ€æ–°æ¶ˆæ¯ï¼Œæå–æ–°çš„ä¿¡æ¯
2. æ›´æ–°å·²æ”¶é›†çš„æ§½ä½
3. å¦‚æœä¿¡æ¯å®Œæ•´ï¼Œè°ƒç”¨å·¥å…·æœç´¢æ¨èç»“æœ
4. å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œå‹å¥½åœ°å‘ç”¨æˆ·è¿½é—®ç¼ºå¤±ä¿¡æ¯
5. ç”Ÿæˆè‡ªç„¶ã€å‹å¥½çš„å›å¤

ä½ çš„å›å¤ï¼š
"""
```

### 4.3 å®ä½“æŠ½å–æç¤ºè¯

```python
ENTITY_EXTRACTION_PROMPT = """
ä»ä»¥ä¸‹ç”¨æˆ·æ¶ˆæ¯ä¸­æå–é™ªè¯Šé¢„çº¦ç›¸å…³çš„å®ä½“ä¿¡æ¯ã€‚

ç”¨æˆ·æ¶ˆæ¯ï¼š"{user_message}"

å½“å‰æ—¥æœŸæ—¶é—´ï¼š{current_datetime}

è¯·æå–ä»¥ä¸‹ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š
- appointment_time: é¢„çº¦æ—¶é—´ï¼ˆè½¬æ¢ä¸º YYYY-MM-DD HH:MM æ ¼å¼ï¼‰
- hospital_name: åŒ»é™¢åç§°
- department: ç§‘å®¤
- service_type: æœåŠ¡ç±»å‹ï¼ˆåŸºç¡€é™ªè¯Š/ä¸“å®¶é™ªè¯Š/å…¨ç¨‹é™ªæŠ¤ï¼‰
- service_spec: æœåŠ¡è§„æ ¼ï¼ˆ2å°æ—¶/4å°æ—¶/å…¨å¤©ï¼‰
- need_pickup: æ˜¯å¦éœ€è¦æ¥é€ï¼ˆtrue/falseï¼‰
- pickup_type: æ¥é€ç±»å‹ï¼ˆboth/pickup_only/dropoff_onlyï¼‰
- pickup_address: æ¥é€åœ°å€
- special_needs: ç‰¹æ®Šéœ€æ±‚

è¿”å› JSON æ ¼å¼ï¼š
{
  "entities": {
    "appointment_time": "2025-11-13 09:00",
    "hospital_name": "åŒ—äº¬åå’ŒåŒ»é™¢",
    ...
  },
  "confidence": {
    "appointment_time": 0.95,
    "hospital_name": 0.98,
    ...
  }
}

å¦‚æœæŸä¸ªå­—æ®µæ— æ³•ç¡®å®šï¼Œä¸è¦åŒ…å«åœ¨ç»“æœä¸­ã€‚
"""
```

---

## äº”ã€å·¥å…· (Tools) å®ç°

### 5.1 æœç´¢é™ªè¯Šå¸ˆå·¥å…·

```python
def search_companions(query: str) -> str:
    """
    æ ¹æ®æŸ¥è¯¢æ¡ä»¶æœç´¢é™ªè¯Šå¸ˆ

    Args:
        query: JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æœç´¢æ¡ä»¶
        ç¤ºä¾‹ï¼š{
            "appointment_time": "2025-11-13 09:00",
            "hospital_name": "åŒ—äº¬åå’ŒåŒ»é™¢",
            "need_pickup": true,
            "service_spec": "4å°æ—¶"
        }

    Returns:
        JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æœç´¢ç»“æœ
    """
    import json
    from app.services.recommendation import RecommendationService

    # è§£ææŸ¥è¯¢æ¡ä»¶
    criteria = json.loads(query)

    # è°ƒç”¨æ¨èæœåŠ¡
    rec_service = RecommendationService()
    companions = rec_service.search_companions(
        appointment_time=criteria.get('appointment_time'),
        hospital_name=criteria.get('hospital_name'),
        need_pickup=criteria.get('need_pickup', False),
        service_spec=criteria.get('service_spec'),
        limit=5
    )

    # è¿”å›ç»“æœ
    return json.dumps({
        "companions": [
            {
                "id": c.id,
                "name": c.name,
                "rating": float(c.rating),
                "review_count": c.review_count,
                "has_car": c.has_car,
                "price": c.base_price,
                "specialties": c.specialties
            }
            for c in companions
        ]
    }, ensure_ascii=False)
```

### 5.2 æœç´¢é™ªè¯Šæœºæ„å·¥å…·

```python
def search_institutions(query: str) -> str:
    """
    æ ¹æ®æŸ¥è¯¢æ¡ä»¶æœç´¢é™ªè¯Šæœºæ„

    Args:
        query: JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æœç´¢æ¡ä»¶

    Returns:
        JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æœç´¢ç»“æœ
    """
    import json
    from app.services.recommendation import RecommendationService

    criteria = json.loads(query)

    rec_service = RecommendationService()
    institutions = rec_service.search_institutions(
        hospital_name=criteria.get('hospital_name'),
        limit=3
    )

    return json.dumps({
        "institutions": [
            {
                "id": i.id,
                "name": i.name,
                "rating": float(i.rating),
                "review_count": i.review_count,
                "service_scope": i.service_scope
            }
            for i in institutions
        ]
    }, ensure_ascii=False)
```

### 5.3 çŸ¥è¯†åº“æŸ¥è¯¢å·¥å…·

```python
def query_knowledge_base(question: str) -> str:
    """
    ä»çŸ¥è¯†åº“æŸ¥è¯¢å¹³å°ç›¸å…³é—®é¢˜çš„ç­”æ¡ˆ

    Args:
        question: ç”¨æˆ·é—®é¢˜

    Returns:
        ç­”æ¡ˆæ–‡æœ¬
    """
    # è¿™é‡Œå¯ä»¥ä½¿ç”¨å‘é‡æ•°æ®åº“è¿›è¡Œè¯­ä¹‰æœç´¢
    # ç®€åŒ–ç‰ˆï¼šä½¿ç”¨é¢„å®šä¹‰çš„ FAQ

    FAQ = {
        "æ”¶è´¹æ ‡å‡†": "é™ªè¯Šå¸ˆæ”¶è´¹æ ¹æ®æœåŠ¡æ—¶é•¿ï¼š2å°æ—¶Â¥129-159ï¼Œ4å°æ—¶Â¥199-239...",
        "å¦‚ä½•å–æ¶ˆ": "å¯ä»¥åœ¨è®¢å•è¯¦æƒ…é¡µç‚¹å‡»å–æ¶ˆã€‚è·æœåŠ¡æ—¶é—´24å°æ—¶ä»¥ä¸Šå¯å…¨é¢é€€æ¬¾...",
        "æ”¯ä»˜æ–¹å¼": "ç›®å‰æ”¯æŒå¾®ä¿¡æ”¯ä»˜...",
        # ... æ›´å¤š FAQ
    }

    # ç®€å•å…³é”®è¯åŒ¹é…ï¼ˆå®é™…åº”ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦ï¼‰
    for key, answer in FAQ.items():
        if key in question:
            return answer

    return "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚æ‚¨å¯ä»¥è”ç³»å®¢æœï¼š400-123-4567"
```

---

## å…­ã€æ¨èç®—æ³•

### 6.1 æ¨èå¼•æ“è®¾è®¡

```python
class RecommendationService:
    """é™ªè¯Šå¸ˆ/æœºæ„æ¨èæœåŠ¡"""

    def search_companions(
        self,
        appointment_time: str,
        hospital_name: str,
        need_pickup: bool = False,
        service_spec: str = None,
        limit: int = 5
    ) -> List[Companion]:
        """
        æœç´¢å¹¶æ¨èé™ªè¯Šå¸ˆ

        æ¨èå› ç´ ï¼š
        1. æ—¶é—´åŒ¹é…åº¦ï¼ˆæ˜¯å¦åœ¨è¯¥æ—¶é—´å¯ç”¨ï¼‰
        2. åœ°ç†ä½ç½®ï¼ˆä¸åŒ»é™¢çš„è·ç¦»ï¼‰
        3. è½¦è¾†åŒ¹é…ï¼ˆå¦‚éœ€æ¥é€ï¼Œæ˜¯å¦æœ‰è½¦ï¼‰
        4. æœåŠ¡è¯„åˆ†
        5. ä»·æ ¼
        """
        from app.models import Companion
        from sqlalchemy import and_, or_

        # åŸºç¡€ç­›é€‰
        query = Companion.query.filter(
            Companion.status == 'approved',
            Companion.is_online == True
        )

        # å¦‚æœéœ€è¦æ¥é€ï¼Œå¿…é¡»æœ‰è½¦
        if need_pickup:
            query = query.filter(Companion.has_car == True)

        # TODO: æ·»åŠ æ—¶é—´å¯ç”¨æ€§æ£€æŸ¥
        # TODO: æ·»åŠ åœ°ç†ä½ç½®è¿‡æ»¤

        # è·å–å€™é€‰é™ªè¯Šå¸ˆ
        companions = query.all()

        # è®¡ç®—æ¨èåˆ†æ•°
        scored_companions = []
        for companion in companions:
            score = self._calculate_companion_score(
                companion,
                appointment_time,
                hospital_name,
                need_pickup
            )
            scored_companions.append((companion, score))

        # æŒ‰åˆ†æ•°æ’åº
        scored_companions.sort(key=lambda x: x[1], reverse=True)

        # è¿”å› Top N
        return [c[0] for c in scored_companions[:limit]]

    def _calculate_companion_score(
        self,
        companion: Companion,
        appointment_time: str,
        hospital_name: str,
        need_pickup: bool
    ) -> float:
        """
        è®¡ç®—é™ªè¯Šå¸ˆæ¨èåˆ†æ•°

        åˆ†æ•°ç»„æˆï¼š
        - è¯„åˆ†æƒé‡ï¼š0.4
        - è·ç¦»æƒé‡ï¼š0.3
        - ä»·æ ¼æƒé‡ï¼š0.2
        - å“åº”é€Ÿåº¦æƒé‡ï¼š0.1
        """
        score = 0.0

        # 1. è¯„åˆ†å› ç´ ï¼ˆ0-5åˆ†ï¼Œå½’ä¸€åŒ–åˆ°0-1ï¼‰
        rating_score = float(companion.rating) / 5.0
        score += rating_score * 0.4

        # 2. è·ç¦»å› ç´ ï¼ˆTODO: å®ç°åœ°ç†ä½ç½®è®¡ç®—ï¼‰
        # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾éƒ½åœ¨æœåŠ¡èŒƒå›´å†…
        distance_score = 0.8
        score += distance_score * 0.3

        # 3. ä»·æ ¼å› ç´ ï¼ˆä»·æ ¼è¶Šä½åˆ†æ•°è¶Šé«˜ï¼‰
        # å‡è®¾ä»·æ ¼èŒƒå›´ 100-500
        max_price = 500.0
        price_score = 1.0 - (float(companion.services[0].base_price) / max_price)
        score += price_score * 0.2

        # 4. å“åº”é€Ÿåº¦ï¼ˆå®Œæˆè®¢å•æ•°è¶Šå¤šï¼Œç»éªŒè¶Šä¸°å¯Œï¼‰
        response_score = min(companion.completed_orders / 100.0, 1.0)
        score += response_score * 0.1

        return score
```

### 6.2 åŒ¹é…ä¼˜å…ˆçº§

```python
# é™ªè¯Šå¸ˆåŒ¹é…ä¼˜å…ˆçº§
PRIORITY_FACTORS = {
    "time_availability": 1.0,      # æ—¶é—´å¯ç”¨æ€§ï¼ˆç¡¬æ€§æ¡ä»¶ï¼‰
    "has_car_if_needed": 1.0,      # è½¦è¾†åŒ¹é…ï¼ˆç¡¬æ€§æ¡ä»¶ï¼Œå¦‚éœ€æ¥é€ï¼‰
    "rating": 0.4,                 # è¯„åˆ†
    "distance": 0.3,               # è·ç¦»
    "price": 0.2,                  # ä»·æ ¼
    "response_speed": 0.1          # å“åº”é€Ÿåº¦
}
```

---

## ä¸ƒã€ä¸Šä¸‹æ–‡ç®¡ç†

### 7.1 ä¼šè¯çŠ¶æ€ç®¡ç†

```python
class ConversationState:
    """å¯¹è¯çŠ¶æ€ç®¡ç†"""

    def __init__(self, session_id: str):
        self.session_id = session_id
        self.intent = None
        self.slots = {}
        self.confirmed_slots = set()
        self.conversation_stage = "UNDERSTANDING_INTENT"

    def update_slot(self, slot_name: str, value: any, confidence: float = 1.0):
        """æ›´æ–°æ§½ä½å€¼"""
        self.slots[slot_name] = {
            "value": value,
            "confidence": confidence,
            "updated_at": datetime.now()
        }

    def is_slot_filled(self, slot_name: str, threshold: float = 0.8) -> bool:
        """æ£€æŸ¥æ§½ä½æ˜¯å¦å·²å¡«å……ï¼ˆä¸”ç½®ä¿¡åº¦è¶³å¤Ÿï¼‰"""
        if slot_name not in self.slots:
            return False
        return self.slots[slot_name]["confidence"] >= threshold

    def get_missing_required_slots(self) -> List[str]:
        """è·å–ç¼ºå¤±çš„å¿…å¡«æ§½ä½"""
        REQUIRED_SLOTS = [
            "appointment_time",
            "hospital_name",
            "service_type",
            "service_spec",
            "need_pickup"
        ]

        missing = []
        for slot in REQUIRED_SLOTS:
            if not self.is_slot_filled(slot):
                missing.append(slot)

        # å¦‚æœéœ€è¦æ¥é€ï¼Œæ¥é€åœ°å€ä¹Ÿæ˜¯å¿…å¡«
        if self.is_slot_filled("need_pickup") and \
           self.slots["need_pickup"]["value"] == True:
            if not self.is_slot_filled("pickup_address"):
                missing.append("pickup_address")

        return missing

    def is_ready_for_recommendation(self) -> bool:
        """æ˜¯å¦å·²å‡†å¤‡å¥½ç”Ÿæˆæ¨è"""
        return len(self.get_missing_required_slots()) == 0
```

### 7.2 è®°å¿†æŒä¹…åŒ–

```python
# ä½¿ç”¨ Redis å­˜å‚¨ä¼šè¯çŠ¶æ€
import redis
import json

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def save_conversation_state(session_id: str, state: ConversationState):
    """ä¿å­˜ä¼šè¯çŠ¶æ€åˆ° Redis"""
    key = f"conversation:{session_id}"
    value = json.dumps(state.__dict__, default=str)
    redis_client.setex(key, 3600, value)  # è¿‡æœŸæ—¶é—´ 1 å°æ—¶

def load_conversation_state(session_id: str) -> ConversationState:
    """ä» Redis åŠ è½½ä¼šè¯çŠ¶æ€"""
    key = f"conversation:{session_id}"
    value = redis_client.get(key)
    if value:
        data = json.loads(value)
        state = ConversationState(session_id)
        state.__dict__.update(data)
        return state
    return ConversationState(session_id)
```

---

## å…«ã€é”™è¯¯å¤„ç†ä¸é™çº§

### 8.1 LLM è°ƒç”¨å¤±è´¥å¤„ç†

```python
def call_llm_with_retry(prompt: str, max_retries: int = 3):
    """è°ƒç”¨ LLMï¼Œå¸¦é‡è¯•æœºåˆ¶"""
    from tenacity import retry, stop_after_attempt, wait_exponential

    @retry(
        stop=stop_after_attempt(max_retries),
        wait=wait_exponential(multiplier=1, min=2, max=10)
    )
    def _call():
        return llm.predict(prompt)

    try:
        return _call()
    except Exception as e:
        logger.error(f"LLM è°ƒç”¨å¤±è´¥: {e}")
        # é™çº§ï¼šè¿”å›é¢„è®¾å›å¤
        return "æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ã€‚è¯·ç¨åå†è¯•ï¼Œæˆ–è”ç³»å®¢æœï¼š400-123-4567"
```

### 8.2 æ„å›¾è¯†åˆ«å¤±è´¥å¤„ç†

```python
def handle_unclear_intent(user_message: str):
    """å¤„ç†æ„å›¾ä¸æ˜ç¡®çš„æƒ…å†µ"""
    return """
    æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰å®Œå…¨ç†è§£æ‚¨çš„æ„æ€ã€‚

    æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
    1. é¢„çº¦é™ªè¯ŠæœåŠ¡
    2. æŸ¥è¯¢è®¢å•
    3. å›ç­”å¹³å°ç›¸å…³é—®é¢˜

    è¯·é—®æ‚¨éœ€è¦å“ªç§å¸®åŠ©ï¼Ÿ
    """
```

---

## ä¹ã€è¯„ä¼°ä¸ä¼˜åŒ–

### 9.1 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡å€¼ |
|------|------|--------|
| æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ | æ­£ç¡®è¯†åˆ«ç”¨æˆ·æ„å›¾çš„æ¯”ä¾‹ | > 90% |
| æ§½ä½å¡«å……å‡†ç¡®ç‡ | æ­£ç¡®æå–å®ä½“çš„æ¯”ä¾‹ | > 85% |
| å¯¹è¯è½®æ•° | å®Œæˆé¢„çº¦å¹³å‡éœ€è¦çš„å¯¹è¯è½®æ•° | < 10 è½® |
| æˆåŠŸé¢„çº¦ç‡ | å¼€å§‹å¯¹è¯åˆ°æˆåŠŸåˆ›å»ºè®¢å•çš„æ¯”ä¾‹ | > 60% |
| ç”¨æˆ·æ»¡æ„åº¦ | å¯¹è¯ç»“æŸåçš„æ»¡æ„åº¦è¯„åˆ† | > 4.0/5.0 |

### 9.2 A/B æµ‹è¯•

```python
# æµ‹è¯•ä¸åŒçš„æç¤ºè¯ç‰ˆæœ¬
PROMPT_VERSIONS = {
    "v1": "åŸå§‹ç‰ˆæœ¬æç¤ºè¯",
    "v2": "ä¼˜åŒ–åçš„æç¤ºè¯",
    "v3": "ç®€åŒ–ç‰ˆæç¤ºè¯"
}

def get_prompt_for_user(user_id: int) -> str:
    """æ ¹æ® A/B æµ‹è¯•åˆ†æ¡¶è¿”å›ä¸åŒç‰ˆæœ¬çš„æç¤ºè¯"""
    bucket = user_id % 3
    version = f"v{bucket + 1}"
    return PROMPT_VERSIONS[version]
```

### 9.3 æŒç»­ä¼˜åŒ–

1. **æ”¶é›†å¯¹è¯æ—¥å¿—**
   - è®°å½•æ‰€æœ‰å¯¹è¯åˆ°æ•°æ®åº“
   - æ ‡æ³¨æ„å›¾è¯†åˆ«é”™è¯¯çš„æ¡ˆä¾‹
   - åˆ†æå¯¹è¯å¤±è´¥çš„åŸå› 

2. **Fine-tuning**
   - ä½¿ç”¨çœŸå®å¯¹è¯æ•°æ® fine-tune æ¨¡å‹
   - é’ˆå¯¹é¢†åŸŸçŸ¥è¯†ä¼˜åŒ–æç¤ºè¯

3. **çŸ¥è¯†åº“æ‰©å……**
   - å®šæœŸæ›´æ–° FAQ
   - æ·»åŠ æ–°çš„æœåŠ¡ç±»å‹å’Œç‰¹æ®Šåœºæ™¯

---

## åã€å®‰å…¨ä¸åˆè§„

### 10.1 å†…å®¹å®‰å…¨

```python
def content_safety_check(message: str) -> bool:
    """æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦å®‰å…¨"""
    # æ•æ„Ÿè¯è¿‡æ»¤
    SENSITIVE_WORDS = ["æ¶‰æ”¿", "æš´åŠ›", "è‰²æƒ…"]

    for word in SENSITIVE_WORDS:
        if word in message:
            return False

    return True
```

### 10.2 éšç§ä¿æŠ¤

- ä¸åœ¨å¯¹è¯å†å²ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆèº«ä»½è¯å·ã€é“¶è¡Œå¡å·ç­‰ï¼‰
- å¯¹è¯æ—¥å¿—ä¸­è„±æ•å¤„ç†ä¸ªäººä¿¡æ¯
- å®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¹è¯è®°å½•

### 10.3 é˜²æ»¥ç”¨

```python
# å¯¹è¯é¢‘ç‡é™åˆ¶
RATE_LIMIT = {
    "max_messages_per_minute": 20,
    "max_sessions_per_day": 50
}

def check_rate_limit(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¶…è¿‡é¢‘ç‡é™åˆ¶"""
    # ä½¿ç”¨ Redis å®ç°æ»‘åŠ¨çª—å£é™æµ
    # ...
    pass
```

---

## åä¸€ã€éƒ¨ç½²ä¸ç›‘æ§

### 11.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx     â”‚  è´Ÿè½½å‡è¡¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Flask     â”‚  API æœåŠ¡ï¼ˆå¤šå®ä¾‹ï¼‰
â”‚   + Agent   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  OpenRouter â”‚  LLM æœåŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 ç›‘æ§æŒ‡æ ‡

```python
# ä½¿ç”¨ Prometheus + Grafana ç›‘æ§

from prometheus_client import Counter, Histogram

# å¯¹è¯æ¬¡æ•°
conversation_count = Counter(
    'carelink_ai_conversations_total',
    'Total number of AI conversations',
    ['intent', 'status']
)

# LLM è°ƒç”¨å»¶è¿Ÿ
llm_latency = Histogram(
    'carelink_ai_llm_latency_seconds',
    'LLM call latency'
)

# æ¨èæˆåŠŸç‡
recommendation_success = Counter(
    'carelink_ai_recommendation_success_total',
    'Successful recommendations',
    ['type']  # companion/institution
)
```

---

## åäºŒã€é™„å½•

### 12.1 å‚è€ƒèµ„æ–™

- [LangChain å®˜æ–¹æ–‡æ¡£](https://python.langchain.com/docs/get_started/introduction)
- [OpenRouter API æ–‡æ¡£](https://openrouter.ai/docs)
- [å¯¹è¯ç³»ç»Ÿè®¾è®¡æœ€ä½³å®è·µ](https://rasa.com/docs/)

### 12.2 ç¤ºä¾‹ä»£ç ä»“åº“

å®Œæ•´çš„ AI Agent å®ç°ä»£ç å°†ä½äºï¼š
```
Backend/app/services/ai_agent/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ agent.py              # ä¸» Agent ç±»
â”œâ”€â”€ prompts.py            # æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ tools.py              # å·¥å…·å‡½æ•°
â”œâ”€â”€ state.py              # çŠ¶æ€ç®¡ç†
â””â”€â”€ recommendation.py     # æ¨èå¼•æ“
```

---

**æ–‡æ¡£ç»“æŸ**
