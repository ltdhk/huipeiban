# CareLink 医疗陪诊服务平台 - 产品需求文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2025-11-12 |
| 最后更新 | 2025-11-12 |
| 产品名称 | CareLink 医疗陪诊服务平台 |
| 产品定位 | AI Native 智能陪诊预约服务平台 |

---

## 一、项目概述

### 1.1 产品简介

CareLink 是一个基于 AI Native 理念打造的医疗陪诊服务平台，通过智能对话助手帮助用户快速匹配合适的陪诊服务。平台连接有陪诊需求的用户、专业陪诊师和陪诊机构，提供全流程陪诊服务解决方案。

### 1.2 目标用户

#### 主要用户群体
- **C端用户**：需要医疗陪诊服务的患者及其家属
  - 老年患者群体
  - 行动不便的患者
  - 异地就医患者
  - 无家属陪同的患者

- **陪诊师**：提供陪诊服务的专业人员
  - 独立陪诊师
  - 隶属于机构的陪诊师

- **陪诊机构**：提供组织化陪诊服务的机构
  - 专业陪诊公司
  - 医疗服务机构

- **平台管理员**：负责平台运营和管理

### 1.3 核心价值

- **用户侧**：通过 AI 对话自然表达需求，智能匹配服务，简化预约流程
- **陪诊师侧**：获得稳定的订单来源，提升服务效率
- **陪诊机构侧**：扩大服务覆盖范围，提升品牌影响力
- **平台侧**：连接供需双方，提供高效的服务撮合

### 1.4 产品特色

1. **AI Native 交互体验**：基于 LangChain 构建的智能对话系统，自然语言理解用户需求
2. **智能匹配推荐**：根据时间、距离、车辆、评分等多维度因素智能推荐服务
3. **双轨服务模式**：支持陪诊师直约（在线支付）和陪诊机构预约（线下服务）
4. **全流程数字化**：从需求采集、服务匹配、订单管理到评价反馈的完整闭环

---

## 二、技术架构

### 2.1 技术栈定义

#### 前端技术栈
| 模块 | 技术选型 | 说明 |
|------|---------|------|
| 微信小程序 | 微信小程序 + TDesign | C端用户界面 |
| 管理后台 | React 18 + Ant Design 5 | 独立的管理系统前端 |
| 状态管理 | React Context / Zustand | 轻量级状态管理 |
| HTTP 客户端 | Axios | API 请求封装 |

#### 后端技术栈
| 模块 | 技术选型 | 说明 |
|------|---------|------|
| Web 框架 | Flask 3.x | Python 轻量级框架 |
| AI Agent | LangChain | 对话流程编排 |
| ORM | SQLAlchemy | 数据库 ORM |
| 认证 | Flask-JWT-Extended | JWT 认证 |
| API 文档 | Flask-RESTX / Swagger | 自动生成 API 文档 |
<!-- | 任务队列 | Celery + Redis | 异步任务处理 |
| 缓存 | Redis | 缓存和会话存储 | -->

#### 数据存储
| 模块 | 技术选型 | 说明 |
|------|---------|------|
| 关系数据库 | supabse PostgreSQL | 主数据存储 |
<!-- | 缓存数据库 | Redis 7+ | 缓存、会话、消息队列 | -->
| 对象存储 | supabse oss |

#### AI 服务
| 模块 | 技术选型 | 说明 |
|------|---------|------|
| AI 服务提供商 | OpenRouter | 统一的 LLM API 网关 |
| 支持模型 | GPT-4, Claude, 等 | 根据成本和效果选择 |

#### 支付服务
| 模块 | 技术选型 | 说明 |
|------|---------|------|
| 支付方式 | 微信支付 | JSAPI 支付 |
| 支付 SDK | 微信支付 Python SDK | 官方 SDK |

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────────┬───────────────────────────────────────┤
│   微信小程序         │      React 管理后台                    │
│   (TDesign UI)      │      (Ant Design)                     │
└─────────┬───────────┴────────────┬──────────────────────────┘
          │                        │
          │    HTTPS/WSS          │    HTTPS
          │                        │
┌─────────▼────────────────────────▼──────────────────────────┐
│                      API 网关层                              │
│                   (Nginx + Flask)                           │
├─────────────────────┬───────────────────────────────────────┤
│   用户端 API         │      管理端 API                        │
└─────────┬───────────┴────────────┬──────────────────────────┘
          │                        │
┌─────────▼────────────────────────▼──────────────────────────┐
│                      业务逻辑层                              │
├──────────────────────────────────────────────────────────────┤
│  认证服务  │  AI Agent  │  订单服务  │  支付服务  │  消息服务 │
│  (JWT)    │(LangChain) │  (Order)  │ (WxPay)   │ (Message) │
└─────────┬────────────────────────┬──────────────────────────┘
          │                        │
┌─────────▼────────────────────────▼──────────────────────────┐
│                      数据访问层                              │
├──────────────────────────────────────────────────────────────┤
│              SQLAlchemy ORM + Redis Client                   │
└─────────┬────────────────────────┬──────────────────────────┘
          │                        │
┌─────────▼────────────┐  ┌────────▼─────────────────────────┐
│   PostgreSQL         │  │   Redis Cache/Queue              │
│   (主数据库)          │  │   (缓存/会话/消息队列)            │
└──────────────────────┘  └──────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      外部服务                                │
├──────────────────────────────────────────────────────────────┤
│  OpenRouter  │  微信支付  │  腾讯云COS  │  短信服务(可选)    │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 项目目录结构

```
CareLink/
├── Backend/                    # Flask 后端
│   ├── app/
│   │   ├── __init__.py
│   │   ├── api/
│   │   │   ├── user/          # 用户端 API
│   │   │   └── admin/         # 管理端 API
│   │   ├── models/            # 数据模型
│   │   ├── services/          # 业务逻辑
│   │   │   ├── ai_agent/      # AI Agent 服务
│   │   │   ├── order/         # 订单服务
│   │   │   ├── payment/       # 支付服务
│   │   │   └── message/       # 消息服务
│   │   ├── utils/             # 工具函数
│   │   └── config.py          # 配置文件
│   ├── migrations/            # 数据库迁移
│   ├── tests/                 # 测试用例
│   ├── requirements.txt       # Python 依赖
│   └── run.py                 # 启动文件
│
├── MiniApp/                   # 微信小程序
│   ├── pages/                 # 页面
│   ├── components/            # 组件
│   ├── utils/                 # 工具函数
│   ├── app.js
│   └── app.json
│
├── Admin/                     # React 管理后台
│   ├── src/
│   │   ├── pages/             # 页面
│   │   ├── components/        # 组件
│   │   ├── services/          # API 服务
│   │   ├── utils/             # 工具函数
│   │   ├── App.tsx
│   │   └── main.tsx
│   ├── package.json
│   └── vite.config.ts
│
├── Docs/                      # 项目文档
│   ├── PRD.md                 # 本文档
│   ├── DATABASE.md            # 数据库设计
│   ├── API.md                 # API 接口文档
│   ├── AI_AGENT.md            # AI Agent 设计
│   ├── PAYMENT.md             # 支付集成文档
│   └── ROADMAP.md             # 开发路线图
│
├── Script/                    # 脚本工具
│   ├── deploy/                # 部署脚本
│   └── data/                  # 数据脚本
│
└── CLAUDE.md                  # 开发指南
```

---

## 三、功能模块详述

### 3.1 微信小程序端功能

#### 3.1.1 AI 智能陪诊助手

**页面路径**：`pages/ai-companion/chat`

**功能描述**：
- 用户通过自然语言对话描述陪诊需求
- AI Agent 提取关键信息（时间、地点、服务类型、服务规格、接送需求等）
- 根据提取的信息智能推荐陪诊师或陪诊机构
- 支持多轮对话，逐步完善需求信息

**核心交互流程**：
```
用户: "我需要预约明天上午去协和医院的陪诊服务"
AI: "好的,我已为您记录以下信息:
     - 时间: 明天上午
     - 医院: 协和医院
     请问您需要什么类型的陪诊服务?是普通陪诊还是专家陪诊?"

用户: "普通陪诊就可以,需要接送"
AI: "明白了。根据您的需求,我为您推荐以下服务..."
    [显示陪诊师/机构卡片列表]
```

**需求采集字段**：
- 预约时间
- 就诊医院/地点
- 服务类型（普通陪诊、专家陪诊、全程陪护等）
- 服务规格（2小时、4小时、全天等）
- 是否需要接送
- 特殊需求（轮椅、担架等）

**推荐逻辑**：
根据以下因素进行智能推荐排序：
1. **时间匹配**：陪诊师/机构的可用时间段
2. **距离因素**：与就诊地点的距离
3. **车辆因素**：是否有车（如需接送）
4. **服务评分**：历史评价和评分
5. **服务价格**：价格合理性
6. **响应速度**：平均接单时间

**AI 推荐结果展示**：
- 陪诊师卡片
  - 头像、姓名、评分
  - 所属机构（如有）
  - 服务经验
  - 价格
  - "立即预约"按钮

- 陪诊机构卡片
  - 机构 LOGO、名称
  - 机构评分
  - 服务人数
  - 服务范围
  - "咨询预约"按钮

#### 3.1.2 陪诊师预约流程

**适用场景**：用户选择独立陪诊师或机构下的陪诊师

**流程页面**：
1. `pages/appointment/service-detail` - 服务详情页
2. `pages/appointment/patient-select` - 就诊人选择
3. `pages/appointment/service-specs` - 服务规格选择
4. `pages/appointment/transportation` - 接送选项
5. `pages/appointment/order-confirm` - 订单确认
6. `pages/appointment/payment` - 支付页面

**关键功能点**：

**1) 服务详情页**
- 陪诊师基本信息（头像、姓名、性别、年龄、从业年限）
- 服务评分和评价数量
- 服务介绍和擅长领域
- 认证信息（资质证书、健康证等）
- 可预约时间段日历展示
- 服务价格说明

**2) 就诊人选择**
- 展示已保存的就诊人列表
- 支持新增就诊人
- 就诊人信息：姓名、性别、年龄、联系电话、证件号、病史摘要

**3) 服务规格选择**
- 2小时陪诊（适合简单挂号检查）
- 4小时陪诊（半天带检验检查）
- 全天陪诊（多项检查或手术）
- VIP服务（一对一专属陪护）
- 价格差异展示

**4) 接送选项**
- 只接（从指定地点接到医院）
- 只送（从医院送回指定地点）
- 接送（往返接送）
- 不需要接送（自行前往）
- 接送地址选择（已保存地址或新增地址）

**5) 订单确认**
- 预约信息汇总
  - 医院名称和科室
  - 预约时间
  - 就诊人信息
  - 服务规格
  - 接送方式
- 陪诊师信息
- 订单备注（选填）
- 费用明细
  - 服务费
  - 接送费（如有）
  - 优惠券抵扣（如有）
  - 总计金额

**6) 支付页面**
- 支付方式选择（微信支付）
- 支付金额展示
- 支付成功/失败处理
- 支付成功后跳转到订单详情

**支付流程**：
```
确认订单 → 创建订单 → 调起微信支付 → 支付回调 → 订单状态更新 → 通知陪诊师
```

#### 3.1.3 陪诊机构预约流程

**适用场景**：用户选择陪诊机构（无需线上支付）

**流程页面**：
1. `pages/appointment/institution-detail` - 机构详情页
2. `pages/appointment/patient-select` - 就诊人选择
3. `pages/appointment/requirement-form` - 需求表单填写
4. `pages/appointment/submit-success` - 提交成功页

**关键功能点**：

**1) 机构详情页**
- 机构基本信息（LOGO、名称、简介）
- 服务评分和评价数量
- 服务范围（覆盖医院、服务项目）
- 机构资质（营业执照、许可证等）
- 服务案例展示
- 联系方式

**2) 需求表单**
- 预约时间
- 就诊医院
- 服务类型
- 特殊需求说明
- 联系电话（用于机构回访）

**3) 提交成功**
- 显示"已提交，机构将在24小时内联系您"
- 展示机构联系方式
- 创建待服务订单记录
- 不涉及线上支付环节

**与陪诊师预约的区别**：
| 项目 | 陪诊师预约 | 机构预约 |
|------|-----------|---------|
| 支付方式 | 线上支付（微信支付） | 线下支付（不经过平台） |
| 服务确认 | 陪诊师接单 | 机构电话联系 |
| 价格透明度 | 价格明确 | 价格由机构线下协商 |
| 订单状态 | 待支付→待服务→服务中→已完成 | 待服务→服务中→已完成 |
| 平台抽佣 | 是 | 否（或固定会员费） |

#### 3.1.4 订单管理

**页面路径**：`pages/orders/orders-list`

**订单状态定义**：

**陪诊师订单状态流转**：
```
待支付 → 待接单 → 待服务 → 服务中 → 已完成
   ↓         ↓
 已取消    已取消
```

**陪诊机构订单状态流转**：
```
待服务 → 服务中 → 已完成
   ↓
 已取消
```

**状态说明**：

| 状态 | 说明 | 用户可操作 | 陪诊师可操作 |
|------|------|-----------|-------------|
| 待支付 | 订单已创建,等待支付 | 去支付、取消订单 | - |
| 待接单 | 已支付,等待陪诊师接单 | 取消订单(退款) | 接单、拒绝 |
| 待服务 | 已接单,等待服务时间 | 查看详情、联系陪诊师、取消(扣手续费) | 查看详情、联系用户 |
| 服务中 | 正在提供服务 | 查看详情、联系陪诊师 | 开始服务、完成服务 |
| 已完成 | 服务已完成 | 评价、再次预约 | 查看评价 |
| 已取消 | 订单已取消 | 查看详情 | - |

**订单列表筛选**：
- 全部
- 待支付
- 待服务
- 服务中
- 已完成

**订单卡片信息**：
- 订单类型标识（陪诊师/机构）
- 服务对象（陪诊师姓名或机构名称）
- 预约时间
- 就诊医院
- 订单状态
- 订单金额（陪诊师订单）
- 操作按钮

**订单详情页** (`pages/orders/order-detail`)：
- 订单编号
- 订单状态
- 预约信息
  - 就诊人信息
  - 预约时间
  - 就诊医院
  - 服务规格
  - 接送信息
- 陪诊师/机构信息
- 费用明细
- 订单备注
- 操作记录（创建、支付、接单、开始服务、完成服务）
- 联系按钮（拨打电话、发送消息）
- 取消订单按钮（符合条件时显示）

**取消订单规则**：
- 待支付状态：可随时取消,无手续费
- 待接单状态：可取消并全额退款
- 待服务状态：
  - 距服务时间 24 小时以上：退款 90%
  - 距服务时间 12-24 小时：退款 50%
  - 距服务时间 12 小时内：不可取消
- 服务中、已完成：不可取消

#### 3.1.5 消息中心

**页面路径**：`pages/messages/message-center`

**功能模块**：

**1) 消息列表**
- 系统通知（订单状态变更、平台公告等）
- 陪诊师对话列表
- 机构对话列表
- 客服对话
- 未读消息数量标识
- 消息搜索功能

**2) 一对一聊天** (`pages/messages/chat`)
- 实时消息收发
- 消息类型支持：
  - 文本消息
  - 图片消息
  - 位置消息（方便接送）
  - 语音消息（可选）
- 消息已读/未读状态
- 历史消息加载
- 快捷回复（常用语）

**3) 系统通知**
- 订单状态变更通知
  - "您的订单已接单"
  - "陪诊师已开始服务"
  - "服务已完成,请评价"
- 平台活动通知
- 优惠券到账通知

**消息推送策略**：
- 订单关键节点：小程序订阅消息 + 站内消息
- 陪诊师消息：站内消息 + 未读角标
- 系统通知：站内消息

#### 3.1.6 个人中心

**页面路径**：`pages/profile/index`

**功能模块**：

**1) 用户信息区**
- 头像、昵称
- 用户 ID
- 会员等级（可选）
- 编辑资料按钮

**2) 我的收藏** (`pages/profile/favorites`)
- 收藏的陪诊师列表
- 一键取消收藏
- 快速预约

**3) 优惠券** (`pages/profile/coupons`)
- 优惠券列表（未使用、已使用、已过期）
- 优惠券详情（面额、使用条件、有效期）
- 优惠券核销记录

**4) 关注的陪诊师** (`pages/profile/followed-companions`)
- 关注列表
- 陪诊师动态（可选）
- 快速预约

**5) 就诊人管理** (`pages/profile/patients`)
- 就诊人列表
- 新增就诊人
- 编辑就诊人信息
- 删除就诊人
- 设置默认就诊人

**6) 地址管理** (`pages/profile/addresses`)
- 常用地址列表
- 新增地址
- 编辑地址
- 删除地址
- 设置默认地址
- 地址类型（家、公司、其他）

**7) 我的钱包** (`pages/profile/wallet`)
- 余额显示
- 充值功能
- 消费记录
- 提现功能（如适用）

**8) 帮助与反馈** (`pages/profile/help`)
- 常见问题 FAQ
- 在线客服
- 意见反馈
- 关于我们
- 用户协议
- 隐私政策

**9) 设置** (`pages/profile/settings`)
- 账号安全（修改手机号、设置支付密码）
- 消息推送设置
- 清除缓存
- 退出登录

#### 3.1.7 首页（可选）

**页面路径**：`pages/index/index`

如需要传统首页,可包含：
- Banner 轮播图（平台活动）
- 快速入口（AI 预约、我的订单、消息中心）
- 热门陪诊师推荐
- 服务分类导航
- 最新动态

**导航设计**：
建议采用侧边栏导航 + 底部 TabBar 结合：
- 侧边栏：AI 预约、订单、消息、我的
- 底部 TabBar（可选）：首页、发现、消息、我的

### 3.2 管理后台功能

#### 3.2.1 用户管理

**页面路径**：`/admin/users`

**功能列表**：
- 用户列表查询（分页、搜索、筛选）
- 用户详情查看
- 用户状态管理（正常、禁用）
- 用户标签管理
- 用户消费统计
- 导出用户数据

**筛选条件**：
- 注册时间范围
- 用户状态
- 订单数量范围
- 消费金额范围

**用户详情**：
- 基本信息（手机号、昵称、注册时间）
- 就诊人信息
- 订单记录
- 消费统计
- 优惠券使用记录
- 操作日志

#### 3.2.2 订单管理

**页面路径**：`/admin/orders`

**功能列表**：
- 订单列表查询（分页、搜索、筛选）
- 订单详情查看
- 订单状态管理
- 退款处理
- 订单数据导出
- 订单统计报表

**筛选条件**：
- 订单类型（陪诊师订单、机构订单）
- 订单状态
- 创建时间范围
- 服务时间范围
- 陪诊师/机构
- 订单金额范围

**订单详情**：
- 订单基本信息
- 用户信息
- 服务提供方信息
- 费用明细
- 支付信息
- 操作记录
- 退款记录（如有）

**订单操作**：
- 强制取消订单
- 退款审批
- 订单备注
- 客服介入

#### 3.2.3 陪诊师管理

**页面路径**：`/admin/companions`

**功能列表**：
- 陪诊师列表查询
- 陪诊师审核（资质审核）
- 陪诊师详情查看
- 陪诊师状态管理（启用、禁用）
- 陪诊师评分管理
- 陪诊师分配（可选，手动分配订单）
- 数据统计（接单量、好评率、收入等）

**陪诊师资料**：
- 基本信息（姓名、性别、年龄、手机号）
- 身份认证（身份证、健康证）
- 资质证书（护理证、陪护证等）
- 服务范围（擅长领域、服务医院）
- 是否有车
- 所属机构（如有）
- 服务定价
- 银行卡信息（用于结算）

**审核流程**：
```
陪诊师注册 → 提交资料 → 平台审核 → 审核通过 → 开始接单
                              ↓
                          审核拒绝 → 修改资料 → 重新审核
```

**陪诊师统计**：
- 总接单量
- 完成订单数
- 取消订单数
- 好评率
- 平均评分
- 总收入
- 月度趋势图

#### 3.2.4 陪诊机构管理

**页面路径**：`/admin/institutions`

**功能列表**：
- 机构列表查询
- 机构审核
- 机构详情查看
- 机构状态管理
- 机构评分管理
- 机构旗下陪诊师管理
- 数据统计

**机构资料**：
- 基本信息（机构名称、法人、联系电话）
- 营业执照
- 医疗相关许可证
- 服务范围
- 机构地址
- 机构简介
- 对公账户信息

**机构旗下陪诊师**：
- 陪诊师列表
- 添加/移除陪诊师
- 陪诊师业绩统计

**机构统计**：
- 总订单数
- 完成订单数
- 好评率
- 平均评分
- 服务用户数

#### 3.2.5 评价管理

**页面路径**：`/admin/reviews`

**功能列表**：
- 评价列表查询
- 评价详情查看
- 违规评价处理（隐藏、删除）
- 评价回复管理
- 评价数据统计

**评价内容**：
- 评价对象（陪诊师/机构）
- 评价用户
- 评分（1-5星）
- 评价标签（服务态度好、专业、准时等）
- 评价内容
- 评价图片（可选）
- 评价时间
- 陪诊师/机构回复

#### 3.2.6 财务管理

**页面路径**：`/admin/finance`

**功能模块**：

**1) 收入统计**
- 总收入
- 日/周/月收入趋势
- 订单收入占比（陪诊师订单 vs 机构会员费）
- 退款统计

**2) 结算管理**
- 待结算订单列表
- 陪诊师提现申请
- 结算记录
- 结算明细导出

**3) 对账管理**
- 微信支付对账
- 订单对账
- 差异处理

#### 3.2.7 内容管理

**页面路径**：`/admin/content`

**功能列表**：
- Banner 管理（首页轮播图）
- 公告管理
- 帮助中心内容管理
- 服务协议管理
- 隐私政策管理

#### 3.2.8 数据统计

**页面路径**：`/admin/dashboard`

**核心指标**：
- 用户总数、新增用户
- 订单总数、今日订单
- 总交易额、今日交易额
- 陪诊师总数、活跃陪诊师
- 陪诊机构总数

**数据报表**：
- 用户增长趋势
- 订单趋势
- 收入趋势
- 陪诊师业绩排行
- 热门服务类型
- 热门医院排行
- 用户地域分布

#### 3.2.9 系统设置

**页面路径**：`/admin/settings`

**功能列表**：
- 平台基础配置
  - 平台名称、LOGO
  - 客服联系方式
  - 服务时间设置
- 订单配置
  - 超时自动取消时间
  - 退款手续费比例
  - 接单超时时间
- 佣金配置
  - 平台抽佣比例
  - 结算周期
- 支付配置
  - 微信支付配置（商户号、密钥等）
- AI 配置
  - OpenRouter API Key
  - 模型选择
  - 提示词模板
- 管理员管理
  - 管理员账号管理
  - 角色权限管理

---

## 四、核心业务流程

### 4.1 陪诊师预约完整流程

```
┌─────────┐
│ 用户    │
└────┬────┘
     │
     │ 1. 打开 AI 陪诊助手
     ▼
┌─────────────────────────┐
│  AI Agent 对话交互       │
│  - 提取需求信息          │
│  - 智能推荐陪诊师        │
└────────┬────────────────┘
         │
         │ 2. 用户选择陪诊师
         ▼
┌─────────────────────────┐
│  填写预约信息            │
│  - 选择就诊人            │
│  - 选择服务规格          │
│  - 选择接送方式          │
└────────┬────────────────┘
         │
         │ 3. 确认订单
         ▼
┌─────────────────────────┐
│  创建订单（待支付）       │
└────────┬────────────────┘
         │
         │ 4. 调起微信支付
         ▼
┌─────────────────────────┐
│  支付成功                │
│  订单状态：待接单         │
└────────┬────────────────┘
         │
         │ 5. 推送通知给陪诊师
         ▼
┌─────────────────────────┐
│  陪诊师接单              │
│  订单状态：待服务         │
└────────┬────────────────┘
         │
         │ 6. 推送通知给用户
         │    用户和陪诊师可互发消息
         ▼
┌─────────────────────────┐
│  服务时间到达            │
│  陪诊师开始服务          │
│  订单状态：服务中         │
└────────┬────────────────┘
         │
         │ 7. 服务完成
         ▼
┌─────────────────────────┐
│  陪诊师标记服务完成       │
│  订单状态：已完成         │
└────────┬────────────────┘
         │
         │ 8. 推送评价提醒
         ▼
┌─────────────────────────┐
│  用户评价                │
│  结算给陪诊师            │
└─────────────────────────┘
```

### 4.2 陪诊机构预约完整流程

```
┌─────────┐
│ 用户    │
└────┬────┘
     │
     │ 1. 打开 AI 陪诊助手
     ▼
┌─────────────────────────┐
│  AI Agent 对话交互       │
│  - 提取需求信息          │
│  - 智能推荐陪诊机构      │
└────────┬────────────────┘
         │
         │ 2. 用户选择陪诊机构
         ▼
┌─────────────────────────┐
│  填写预约信息            │
│  - 选择就诊人            │
│  - 填写需求说明          │
└────────┬────────────────┘
         │
         │ 3. 提交预约
         ▼
┌─────────────────────────┐
│  创建订单（待服务）       │
│  无需支付                │
└────────┬────────────────┘
         │
         │ 4. 推送通知给机构
         ▼
┌─────────────────────────┐
│  机构联系用户            │
│  线下协商服务细节        │
└────────┬────────────────┘
         │
         │ 5. 服务时间到达
         ▼
┌─────────────────────────┐
│  机构提供服务            │
│  订单状态：服务中         │
└────────┬────────────────┘
         │
         │ 6. 服务完成
         ▼
┌─────────────────────────┐
│  机构标记服务完成        │
│  订单状态：已完成         │
└────────┬────────────────┘
         │
         │ 7. 推送评价提醒
         ▼
┌─────────────────────────┐
│  用户评价                │
└─────────────────────────┘
```

### 4.3 AI Agent 对话流程

```
┌─────────────────────────┐
│  用户发送消息            │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  LangChain Agent         │
│  1. 意图识别             │
│     - 新建预约           │
│     - 查询订单           │
│     - 修改预约           │
│     - 咨询问题           │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  2. 实体提取             │
│     - 时间               │
│     - 地点               │
│     - 服务类型           │
│     - 特殊需求           │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  3. 槽位填充             │
│     检查必填信息是否完整  │
└────────┬────────────────┘
         │
         ├─ 不完整 ─┐
         │           ▼
         │      ┌─────────────────┐
         │      │  继续追问        │
         │      │  "还需要XX信息"  │
         │      └────────┬────────┘
         │               │
         │               └─────────┐
         │                         │
         └─ 完整 ─┐                │
                   ▼                │
         ┌─────────────────────┐  │
         │  4. 调用推荐引擎     │  │
         │     根据提取的信息   │  │
         │     查询匹配的服务   │  │
         └────────┬────────────┘  │
                  │                 │
                  ▼                 │
         ┌─────────────────────┐  │
         │  5. 生成推荐结果     │  │
         │     返回陪诊师/机构  │  │
         │     卡片列表         │  │
         └────────┬────────────┘  │
                  │                 │
                  ▼                 │
         ┌─────────────────────┐  │
         │  展示给用户          │  │
         └──────────────────────┘  │
                                    │
                  ┌─────────────────┘
                  │
                  ▼
         ┌─────────────────────┐
         │  用户继续对话        │
         └──────────────────────┘
```

### 4.4 支付与结算流程

**支付流程**：
```
用户确认订单 → 后端创建支付订单 → 调用微信统一下单 API
     ↓
获取预支付信息 → 小程序调起微信支付 → 用户输入密码
     ↓
微信支付成功 → 微信异步回调通知 → 后端验证签名
     ↓
更新订单状态为"待接单" → 推送通知给陪诊师 → 将资金冻结在平台
```

**结算流程**：
```
服务完成 → 订单状态变为"已完成" → 等待评价期（7天）
     ↓
评价期结束或用户已评价 → 订单进入"可结算"状态
     ↓
陪诊师发起提现申请 → 平台审核
     ↓
审核通过 → 计算佣金（平台抽佣10-20%） → 转账到陪诊师账户
     ↓
结算完成 → 记录结算日志
```

**退款流程**：
```
用户申请取消订单 → 系统判断是否允许取消
     ↓
允许取消 → 计算退款金额（根据取消时间）
     ↓
调用微信退款 API → 微信异步回调 → 验证签名
     ↓
更新订单状态为"已取消" → 退款成功 → 推送通知给用户
```

---

## 五、用户角色与权限

### 5.1 用户角色定义

| 角色 | 说明 | 访问端 |
|------|------|--------|
| C端用户 | 需要陪诊服务的患者及家属 | 微信小程序 |
| 陪诊师 | 提供陪诊服务的个人 | 微信小程序（陪诊师端，可选） |
| 陪诊机构 | 提供陪诊服务的机构 | 微信小程序（机构端，可选） |
| 平台管理员 | 平台运营和管理人员 | React 管理后台 |
| 客服 | 处理用户咨询和投诉 | React 管理后台 |
| 财务 | 处理结算和对账 | React 管理后台 |

### 5.2 权限矩阵

#### C端用户权限
- 浏览陪诊师/机构信息
- 创建陪诊预约
- 支付订单
- 查看订单
- 取消订单
- 与陪诊师/机构沟通
- 评价服务
- 管理个人信息
- 管理就诊人信息
- 管理收货地址

#### 陪诊师权限
- 查看接单通知
- 接受/拒绝订单
- 查看订单详情
- 开始/完成服务
- 与用户沟通
- 查看收入
- 申请提现
- 查看评价
- 更新个人资料

#### 陪诊机构权限
- 查看预约通知
- 查看订单详情
- 标记服务状态
- 与用户沟通
- 管理机构信息
- 查看评价
- 管理旗下陪诊师（如平台支持）

#### 平台管理员权限（完整权限）
- 所有管理功能
- 系统配置
- 数据统计
- 财务管理
- 用户管理
- 订单管理
- 陪诊师/机构管理

#### 客服权限
- 查看用户信息
- 查看订单信息
- 处理投诉
- 订单备注
- 有限的订单操作（取消、退款申请）

#### 财务权限
- 查看订单
- 结算管理
- 对账管理
- 财务报表

---

## 六、非功能性需求

### 6.1 性能要求

| 指标 | 要求 |
|------|------|
| API 响应时间 | P95 < 500ms, P99 < 1s |
| AI 对话响应 | < 3s (流式输出) |
| 页面加载时间 | 首屏 < 2s |
| 支持并发数 | 1000 QPS (初期) |
| 数据库查询 | 单表查询 < 100ms |

### 6.2 安全要求

- **数据加密**：
  - HTTPS 传输
  - 敏感数据（手机号、身份证）加密存储
  - 支付密钥安全管理

- **认证授权**：
  - JWT Token 认证
  - Token 过期时间：2小时
  - Refresh Token 机制

- **数据安全**：
  - 定期数据备份
  - SQL 注入防护
  - XSS 防护
  - CSRF 防护

- **隐私保护**：
  - 遵循《个人信息保护法》
  - 用户数据脱敏
  - 数据访问日志记录

### 6.3 可用性要求

- **服务可用性**：99.5%
- **数据备份**：每日全量备份 + 实时增量备份
- **容灾方案**：数据库主从复制，应用服务多节点部署
- **监控告警**：
  - 服务健康检查
  - 异常日志告警
  - 性能指标监控

### 6.4 可扩展性

- **水平扩展**：
  - 应用服务无状态设计
  - 数据库读写分离
  - 缓存分布式部署

- **模块化设计**：
  - 服务拆分（订单服务、支付服务、消息服务等）
  - API 版本管理

- **第三方集成**：
  - 支付渠道可扩展（支付宝、银联）
  - AI 服务商可切换
  - 短信/邮件服务可配置

### 6.5 兼容性

- **微信小程序**：
  - 微信基础库版本：>= 2.10.0
  - iOS / Android 全平台支持

- **管理后台**：
  - Chrome >= 90
  - Firefox >= 88
  - Safari >= 14
  - Edge >= 90

### 6.6 日志与监控

- **日志类型**：
  - 访问日志（Access Log）
  - 错误日志（Error Log）
  - 业务日志（Business Log）
  - 支付日志（Payment Log）

- **监控指标**：
  - API 调用次数和耗时
  - 错误率
  - 数据库连接池状态
  - Redis 缓存命中率
  - 服务器 CPU/内存/磁盘使用率

---

## 七、数据字典（概要）

详细的数据库设计见 [DATABASE.md](./DATABASE.md)

### 核心数据表

| 表名 | 说明 |
|------|------|
| users | 用户表 |
| patients | 就诊人表 |
| addresses | 用户地址表 |
| companions | 陪诊师表 |
| institutions | 陪诊机构表 |
| services | 服务产品表 |
| service_specs | 服务规格表 |
| orders | 订单表 |
| payments | 支付记录表 |
| reviews | 评价表 |
| messages | 消息表 |
| conversations | 会话表 |
| ai_chat_history | AI 对话历史表 |
| admin_users | 管理员表 |

---

## 八、风险与挑战

### 8.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| AI 服务稳定性 | 对话功能不可用 | 设置降级方案，超时后引导人工客服 |
| 微信支付接口变更 | 支付功能异常 | 及时关注官方文档，做好版本兼容 |
| 并发性能瓶颈 | 系统响应慢 | 提前性能测试，优化慢查询，增加缓存 |
| 数据库性能 | 查询慢 | 合理设计索引，定期优化查询 |

### 8.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 陪诊师服务质量 | 用户投诉 | 严格审核陪诊师资质，建立评价体系，及时处理投诉 |
| 订单纠纷 | 平台信誉受损 | 明确服务条款，设立客服介入机制，保留服务凭证 |
| 恶意刷单 | 财务损失 | 风控系统，异常订单检测，人工审核 |
| 竞争对手 | 市场份额流失 | 持续优化用户体验，建立品牌优势 |

### 8.3 合规风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 医疗服务资质 | 监管风险 | 明确平台定位为"信息撮合"，不提供医疗服务 |
| 个人信息保护 | 法律风险 | 严格遵守隐私政策，数据加密，用户授权 |
| 支付合规 | 资金风险 | 接入正规支付通道，资金流水透明 |

---

## 九、后续规划

### 9.1 第一阶段（MVP）- 2个月

**目标**：验证核心业务模型

- [x] 技术栈选型
- [ ] 数据库设计
- [ ] 后端 API 框架搭建
- [ ] AI Agent 基础功能
- [ ] 小程序核心页面（AI对话、预约、订单）
- [ ] 管理后台核心功能（订单管理、陪诊师管理）
- [ ] 微信支付集成
- [ ] 内部测试

### 9.2 第二阶段（完善功能）- 1个月

- [ ] 消息中心完整功能
- [ ] 评价体系
- [ ] 数据统计报表
- [ ] 优惠券系统
- [ ] 客服系统
- [ ] 小范围试运营

### 9.3 第三阶段（优化迭代）- 持续

- [ ] AI 对话优化（更智能的推荐）
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 陪诊师端独立小程序（可选）
- [ ] 陪诊机构端独立系统（可选）
- [ ] 数据分析和运营工具
- [ ] 营销工具（拼团、砍价等）

### 9.4 未来展望

- 接入多家 AI 服务商，提升对话质量
- 引入陪诊师培训体系
- 建立陪诊服务标准
- 拓展到更多城市
- 增加更多服务类型（康复陪护、居家护理等）
- 与医院/医保系统对接

---

## 十、附录

### 10.1 术语表

| 术语 | 说明 |
|------|------|
| AI Native | 以 AI 为核心驱动的产品设计理念 |
| LangChain | 用于开发 LLM 应用的框架 |
| OpenRouter | LLM API 聚合平台 |
| JSAPI 支付 | 微信小程序内的支付方式 |
| 槽位填充 | 对话系统中提取和填充必要信息的过程 |
| C端 | Consumer 端，即用户端 |
| B端 | Business 端，即商家端（陪诊师/机构） |

### 10.2 参考文档

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [LangChain 文档](https://python.langchain.com/)
- [OpenRouter API 文档](https://openrouter.ai/docs)
- [Flask 文档](https://flask.palletsprojects.com/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Ant Design 文档](https://ant.design/index-cn)
- [TDesign 小程序文档](https://tdesign.tencent.com/miniprogram/overview)

### 10.3 联系方式

如有疑问，请联系：
- 产品负责人：[待补充]
- 技术负责人：[待补充]
- 项目管理：[待补充]

---

**文档结束**
